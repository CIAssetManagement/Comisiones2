sum(cobro$MontoconDescuento),sum(cobro$MontoNetoIVA), efectivosuficiente,
comisionfondos), nrow = 6),row.names = nomresumen)
###############################################################################################################
#                                                Excel                                                        #
###############################################################################################################
#Comisiones por mandato
dia <- Sys.Date()
archivom <- paste0('C:/Users/MATREJO/Documents/Comisiones/cargosCISM_',dia,'.xlsx')
write.xlsx2(cargos,archivom, sheetName = 'cargosCISM', col.names=TRUE, row.names = FALSE, append = FALSE)
write.xlsx2(resumen,archivom, sheet = 'ResumenCobro', col.names = FALSE, row.names = TRUE, append = TRUE)
write.xlsx2(cobro,archivom, sheet = 'completocobro', col.names = TRUE, row.names = FALSE, append = TRUE)
write.xlsx2(diario,archivom, sheet = 'saldoDiarioContratosMes', col.names = TRUE, row.names = TRUE,
append = TRUE)
write.xlsx2(grupos,archivom, sheet = 'Grupos', col.names = TRUE, row.names = FALSE, append = TRUE)
write.xlsx2(especiales,archivom, sheet = 'DescuentosEmpleados', col.names = TRUE, row.names = FALSE,
append = TRUE)
write.xlsx2(cespeciales,archivom, sheet = 'BonificacionesCargos', col.names = TRUE, row.names = FALSE,
append = TRUE)
#Clientes en corto
archivon <- 'C:/Users/MATREJO/Documents/Comisiones/ClientesenCorto.xlsx'
write.xlsx2(efectivo,archivon, sheetName = 'Clientes', col.names=TRUE, row.names = FALSE, append = FALSE)
dias_mes
library(dplyr)
library(tidyr)
library(readxl)
library(xlsx)
###############################################################################################################
#                                           Dias del mes                                                      #
###############################################################################################################
dias <- diff(seq(as.Date("2017-01-01"), Sys.Date()+16, by = "month"))
dias_mes <- as.integer(dias[length(dias)])
#Cambiar el -1 por el último dia del que se tengan datos, es decir, si son de antier va un -2.
diahoy <- Sys.Date()-2
###############################################################################################################
#                           Funcion que asigna la comision de acuerdo al monto                                #
###############################################################################################################
cajon <- function(monto){
montos <- c(999999,5000000,7500000,10000000,30000000,100000000)
if(monto < montos[1]){renglon <- 1}
if(between(monto,montos[1],montos[2])){renglon <- 2}
if(between(monto,montos[2],montos[3])){renglon <- 3}
if(between(monto,montos[3],montos[4])){renglon <- 4}
if(between(monto,montos[4],montos[5])){renglon <- 5}
if(between(monto,montos[5],montos[6])){renglon <- 6}
if(monto > montos[6]){renglon <- 7}
return(renglon)
}
cajon2 <- function(monto){
montos <- c(999999,4999999,29999999,99999999,100000000)
series <- c('C-4','C-3','C-2','C-1','C-0')
if(monto < montos[1]){renglon <- series[1]}
if(between(monto,montos[1],montos[2])){renglon <- series[2]}
if(between(monto,montos[2],montos[3])){renglon <- series[3]}
if(between(monto,montos[3],montos[4])){renglon <- series[4]}
if(monto > montos[5]){renglon <- series[5]}
return(renglon)
}
cajon3 <- function(monto){
series <- c("F1","F3")
montos <- 9999999
if(monto <= montos){renglon <- series[1]}
if(monto > montos){renglon <- series[2]}
return(renglon)
}
###############################################################################################################
#                                               Datos                                                         #
###############################################################################################################
datos <- read.csv("datos.csv",header = TRUE)
datos <- cbind(datos,Codigo=paste0(datos$emisora," ",datos$serie))
datos$Codigo <- gsub( "\\+", "", datos$Codigo)
###############################################################################################################
#                                        Carteras Testigo                                                     #
###############################################################################################################
lista <- data.frame(read_excel("comisiones.xlsx",sheet = 'Testigo'))
testigo <- ifelse(datos$contrato %in% lista$contrato, "Sacar", "No Sacar")
datos <- cbind(datos,testigo)
datos <- datos %>% filter(testigo == "No Sacar")
datos$testigo <-  NULL
###############################################################################################################
#                                        Posiciones con fondos                                                #
###############################################################################################################
lista <- c("AXESEDM","NAVIGTR","+CIGUB","+CIGUMP","+CIGULP","+CIPLUS","+CIUSD","+CIEQUS","+CIBOLS")
funds <- ifelse(datos$emisora %in% lista, "Fondo", "No Fondo")
datos <- cbind(datos,funds)
fondos <- datos %>% filter(funds == "Fondo")
fondos <- data.frame(fecha =fondos$fecha,contrato =fondos$contrato,mon = fondos$mon,Codigo =fondos$Codigo)
sinfondos <- datos %>% filter(funds == "No Fondo")
#La siguiente linea se usa en caso de cobrar con mandato lo que pueda estar en fondos.
#sinfondos <- datos
sinfondos <- data.frame(fecha =sinfondos$fecha,contrato =sinfondos$contrato,cartera = sinfondos$carteramodelo ,
mon = sinfondos$mon,Codigo =sinfondos$Codigo,Emisora = sinfondos$emisora)
sinfondos$mon <- ifelse(sinfondos$mon > 0 , sinfondos$mon, 0)
###############################################################################################################
#                                                 Grupos                                                      #
###############################################################################################################
grupos <- data.frame(read_excel("comisiones.xlsx",sheet = 'Grupos'))
indicesg <- match(sinfondos$contrato,grupos$Titular)
grupo <- grupos$Grupo[indicesg]
sinfondos <- cbind(sinfondos,Grupo = grupo)
grupo1 <- sinfondos %>% group_by(Grupo,fecha) %>% summarise(Monto_Grupal = sum(mon))
sinfondos <- data.frame(merge(sinfondos, grupo1, by.x=c("fecha", "Grupo"), by.y=c("fecha", "Grupo")))
indiceserror <- which(is.na(sinfondos$Grupo) == TRUE)
sinfondos$Monto_Grupal[indiceserror] <- sinfondos$mon[indiceserror]
###############################################################################################################
#                                             Clientes especiales                                             #
###############################################################################################################
especiales <- data.frame(read_excel("comisiones.xlsx",sheet = 'Especiales'))
indicese <- match(sinfondos$contrato,especiales$Titular)
descuento <- 1 - especiales$Descuento[indicese]
descuento[is.na(descuento)] <- 1
sinfondos <- cbind(sinfondos,Descuento=descuento)
###############################################################################################################
#                                    Comisiones por instrumentos en fondos                                    #
###############################################################################################################
comision_fondo <- data.frame(read_excel("comisiones.xlsx",sheet = 'ComisionesFondos'))
comision_fondo$Fondo <- as.character(comision_fondo$Fondo)
indicesc <- match(fondos$Codigo,comision_fondo$Fondo)
comision_anualf <- comision_fondo$Comision[indicesc]
comision_diariaf <- comision_anualf / 365
comisionf <- fondos$mon * comision_diariaf
fondos <- cbind(fondos,Comision = comision_diariaf,MontoComision = comisionf)
comisionfondos <- dias_mes*sum(fondos$MontoComision)/as.numeric(length(unique(fondos$fecha)))
montofondos <- fondos %>% group_by(contrato) %>% summarise(MontoComision = sum(MontoComision))
montofondos$MontoComision <- dias_mes*montofondos$MontoComision/as.numeric(length(unique(fondos$fecha)))
###############################################################################################################
#                              Comisiones por instrumentos fuera de fondos                                    #
###############################################################################################################
comision_sinfondo <- data.frame(read_excel("comisiones.xlsx",sheet = 'ComisionesSinFondos'))
colnames(comision_sinfondo) <- gsub("\\.","-",colnames(comision_sinfondo))
colnames(comision_sinfondo) <- gsub("\\_"," ",colnames(comision_sinfondo))
###############################################################################################################
#                                           Saldo Diario                                                      #
###############################################################################################################
saldo_diario <- sinfondos %>% group_by(contrato,fecha) %>% summarise(Monto = sum(mon))
fechas <- unique(saldo_diario$fecha)
saldo_diario <- saldo_diario %>% complete(nesting(contrato),fecha = fechas,fill = list(Monto = 0))
diario <- data.frame(matrix(saldo_diario$Monto,nrow = length(fechas)),row.names = fechas)
colnames(diario) <- unique(saldo_diario$contrato)
###############################################################################################################
#                                           Cobros Especiales                                                 #
###############################################################################################################
cespeciales <- data.frame(read_excel("comisiones.xlsx",sheet = 'CobrosEspeciales'))
cespeciales$Contrato <- as.integer(cespeciales$Contrato)
bonificacion <- rep(0,length(sinfondos$contrato))
for (i in seq(1,length(cespeciales$Contrato), 1)){
indicesb <- match(cespeciales$Contrato[i],sinfondos$contrato)
bonificacion[indicesb] <- cespeciales$Bonificacion[i]
}
sinfondos <- cbind(sinfondos,Bonificacion = bonificacion)
###############################################################################################################
#                                               Cobro                                                         #
###############################################################################################################
saldopromedio <- colMeans(diario)
contratos <- colnames(diario)
cartera <- as.character(sinfondos$cartera[match(contratos,sinfondos$contrato)])
cobro <- data.frame(cbind(Contrato = contratos,SaldoProm = saldopromedio,Cartera = cartera))
cobro$SaldoProm <- as.numeric(as.character(cobro$SaldoProm))
Datoscobro <- sinfondos %>% group_by(contrato) %>% summarise(Promediogrupal = sum(Monto_Grupal)/as.numeric(length(unique(fondos$fecha))),
Descuento = mean(1-Descuento),
Bonificacion = sum(Bonificacion))
#Comision anual
indicescolumna <- match(cartera,colnames(comision_sinfondo))
indicesrenglon <- as.integer(sapply(Datoscobro$Promediogrupal,cajon))
comision_anuals <- c()
for (i in seq(1,length(indicescolumna),1)){
comision_anuals <- c(comision_anuals,comision_sinfondo[indicesrenglon[i],indicescolumna[i]])
}
Datoscobro <- cbind(Datoscobro,Anual = comision_anuals)
#CIBOLS y CIEQUS (sólo por la reclasificacion tardía).
fondos$Codigo <- as.character(fondos$Codigo)
prueba <- fondos %>%
filter(Codigo == "CIBOLS C-0" | Codigo == "CIEQUS C-0") %>%
group_by(contrato) %>% summarise(Monto = sum(mon)/as.numeric(length(unique(fondos$fecha))),
MontoComision = dias_mes*sum(MontoComision)/as.numeric(length(unique(fondos$fecha))))
serie <- sapply(prueba$Monto,cajon2)
codigo <- paste0("CIBOLS ",serie)
indicesci <- match(codigo,comision_fondo$Fondo)
comision_anualci <- comision_fondo$Comision[indicesci]
comision_anualci <- ifelse(is.na(comision_anualci) == TRUE, 0, comision_anualci)
comision_diariaci <- dias_mes*comision_anualci / 360
comisionci <- prueba$Monto * comision_diariaci
prueba <- data.frame(cbind(prueba,MontoComision2 = comisionci))
prueba$MontoComision2 <- as.numeric(as.character(prueba$MontoComision2))
i <- match(prueba$contrato,Datoscobro$contrato)
MontoComision3 <- prueba$MontoComision2 - prueba$MontoComision
MontoComision3 <- ifelse(MontoComision3 < 0 , 0, MontoComision3)
comisionfondos2 <- MontoComision3[match(contratos,prueba$contrato)]
comisionfondos2 <- ifelse(is.na(comisionfondos2) == TRUE, 0, comisionfondos2)
#AXESEDM (sólo por la reclasificacion tardía)
prueba2 <- fondos %>%
filter(Codigo == "AXESEDM F3") %>%
group_by(contrato) %>% summarise(Monto = sum(mon)/as.numeric(length(unique(fondos$fecha))),
MontoComision = dias_mes*sum(MontoComision)/as.numeric(length(unique(fondos$fecha))))
serie <- sapply(prueba2$Monto,cajon3)
codigo <- paste0("AXESEDM ",serie)
indicesci <- match(codigo,comision_fondo$Fondo)
comision_anualci <- comision_fondo$Comision[indicesci]
comision_anualci <- ifelse(is.na(comision_anualci) == TRUE, 0, comision_anualci)
comision_diariaci <- dias_mes*comision_anualci / 360
comisionci <- prueba2$Monto * comision_diariaci
prueba2 <- data.frame(cbind(prueba2,MontoComision2 = comisionci))
prueba2$MontoComision2 <- as.numeric(as.character(prueba2$MontoComision2))
i <- match(prueba2$contrato,Datoscobro$contrato)
MontoComision4 <- prueba2$MontoComision2 - prueba2$MontoComision
MontoComision4 <- ifelse(MontoComision4 < 0 , 0, MontoComision4)
comisionfondos3 <- MontoComision4[match(contratos,prueba2$contrato)]
comisionfondos3 <- ifelse(is.na(comisionfondos3) == TRUE, 0, comisionfondos3)
comision <- dias_mes*Datoscobro$Anual/360
comisiondesc <- comision * (1-Datoscobro$Descuento)
#############
monto <- (cobro$SaldoProm * dias_mes*Datoscobro$Anual/360)
monto <- ifelse(Datoscobro$Bonificacion <= 0, monto,Datoscobro$Bonificacion/1.16)
#############
montodesc <- (saldopromedio * comisiondesc)
montodesc <- ifelse(montodesc < 0, 0, montodesc) + comisionfondos2 + comisionfondos3
montodesc <- ifelse(Datoscobro$Bonificacion <= 0, montodesc,Datoscobro$Bonificacion/1.16)
montoiva <- montodesc * 1.16
montoneto <- ifelse(Datoscobro$Bonificacion <= 0, montodesc*1.16,Datoscobro$Bonificacion)
cobro <- cbind(cobro,Anual = Datoscobro$Anual,Comision = comision, Descuento = Datoscobro$Descuento,
ComisionConDescuento = comisiondesc, Monto = monto, MontoFondos = comisionfondos2+comisionfondos3,
MontoconDescuento = montodesc, MontoIVA = montoiva,
Bonificacion = Datoscobro$Bonificacion,MontoNetoIVA = montoneto, CobroFinal = montoneto)
cobro[-c(1,3)] <- cobro[-c(1,3)] %>% lapply(as.character) %>% lapply(as.numeric)
###############################################################################################################
#                                             Cargos                                                          #
###############################################################################################################
cargos  <- data.frame(cbind(Contrato = as.character(cobro$Contrato), CobroFinal = cobro$CobroFinal))
cargos$CobroFinal <- as.numeric(as.character(cobro$CobroFinal)) %>% round(4)
###############################################################################################################
#                                   Efectivo que no está en corto                                             #
###############################################################################################################
sinfondos$Codigo <- as.character(sinfondos$Codigo)
sinfondos$fecha <- as.character(sinfondos$fecha)
suficientes <- sinfondos %>% filter(fecha == as.character(diahoy)) %>% filter(Codigo == "EFECTIVO ")
suficientes <- data.frame(cbind(Contrato = suficientes$contrato,Efectivo =suficientes$mon))
efectivo <- data.frame(merge(cargos,suficientes,by.x=c('Contrato'),by.y=c('Contrato'),all.x = TRUE))
efectivo$Efectivo <- ifelse(is.na(efectivo$Efectivo)==TRUE,0,efectivo$Efectivo)
efectivo$Contrato <- as.character(efectivo$Contrato)
efectivo$Efectivo <- ifelse(efectivo$Efectivo>0,efectivo$Efectivo,0)
efectivosuficiente <- sum(ifelse(efectivo$Efectivo > efectivo$Cobro,efectivo$Cobro,efectivo$Efectivo))
###############################################################################################################
#                                              Resumen                                                        #
###############################################################################################################
nomresumen <- c('Dias en el mes','Suma sin Descuentos','Suma neta sin IVA','Suma neta con IVA',
'Suma neta con IVA quitando fondos insuficientes','Suma total en fondos')
resumen <- data.frame(matrix(c(dias_mes,sum(cobro$Monto)+sum(comisionfondos2)+sum(comisionfondos3),
sum(cobro$MontoconDescuento),sum(cobro$MontoNetoIVA), efectivosuficiente,
comisionfondos), nrow = 6),row.names = nomresumen)
###############################################################################################################
#                                                Excel                                                        #
###############################################################################################################
#Comisiones por mandato
dia <- Sys.Date()
archivom <- paste0('C:/Users/MATREJO/Documents/Comisiones/cargosCISM_',dia,'.xlsx')
write.xlsx2(cargos,archivom, sheetName = 'cargosCISM', col.names=TRUE, row.names = FALSE, append = FALSE)
write.xlsx2(resumen,archivom, sheet = 'ResumenCobro', col.names = FALSE, row.names = TRUE, append = TRUE)
write.xlsx2(cobro,archivom, sheet = 'completocobro', col.names = TRUE, row.names = FALSE, append = TRUE)
write.xlsx2(diario,archivom, sheet = 'saldoDiarioContratosMes', col.names = TRUE, row.names = TRUE,
append = TRUE)
write.xlsx2(grupos,archivom, sheet = 'Grupos', col.names = TRUE, row.names = FALSE, append = TRUE)
write.xlsx2(especiales,archivom, sheet = 'DescuentosEmpleados', col.names = TRUE, row.names = FALSE,
append = TRUE)
write.xlsx2(cespeciales,archivom, sheet = 'BonificacionesCargos', col.names = TRUE, row.names = FALSE,
append = TRUE)
#Clientes en corto
archivon <- 'C:/Users/MATREJO/Documents/Comisiones/ClientesenCorto.xlsx'
write.xlsx2(efectivo,archivon, sheetName = 'Clientes', col.names=TRUE, row.names = FALSE, append = FALSE)
library(dplyr)
library(tidyr)
library(readxl)
library(xlsx)
###############################################################################################################
#                                           Dias del mes                                                      #
###############################################################################################################
dias <- diff(seq(as.Date("2017-01-01"), Sys.Date()+16, by = "month"))
dias_mes <- as.integer(dias[length(dias)])
#Cambiar el -1 por el último dia del que se tengan datos, es decir, si son de antier va un -2.
diahoy <- Sys.Date()-2
###############################################################################################################
#                           Funcion que asigna la comision de acuerdo al monto                                #
###############################################################################################################
cajon <- function(monto){
montos <- c(999999,5000000,7500000,10000000,30000000,100000000)
if(monto < montos[1]){renglon <- 1}
if(between(monto,montos[1],montos[2])){renglon <- 2}
if(between(monto,montos[2],montos[3])){renglon <- 3}
if(between(monto,montos[3],montos[4])){renglon <- 4}
if(between(monto,montos[4],montos[5])){renglon <- 5}
if(between(monto,montos[5],montos[6])){renglon <- 6}
if(monto > montos[6]){renglon <- 7}
return(renglon)
}
cajon2 <- function(monto){
montos <- c(999999,4999999,29999999,99999999,100000000)
series <- c('C-4','C-3','C-2','C-1','C-0')
if(monto < montos[1]){renglon <- series[1]}
if(between(monto,montos[1],montos[2])){renglon <- series[2]}
if(between(monto,montos[2],montos[3])){renglon <- series[3]}
if(between(monto,montos[3],montos[4])){renglon <- series[4]}
if(monto > montos[5]){renglon <- series[5]}
return(renglon)
}
cajon3 <- function(monto){
series <- c("F1","F3")
montos <- 9999999
if(monto <= montos){renglon <- series[1]}
if(monto > montos){renglon <- series[2]}
return(renglon)
}
###############################################################################################################
#                                               Datos                                                         #
###############################################################################################################
datos <- read.csv("datos.csv",header = TRUE)
datos <- cbind(datos,Codigo=paste0(datos$emisora," ",datos$serie))
datos$Codigo <- gsub( "\\+", "", datos$Codigo)
###############################################################################################################
#                                        Carteras Testigo                                                     #
###############################################################################################################
lista <- data.frame(read_excel("comisiones.xlsx",sheet = 'Testigo'))
testigo <- ifelse(datos$contrato %in% lista$contrato, "Sacar", "No Sacar")
datos <- cbind(datos,testigo)
datos <- datos %>% filter(testigo == "No Sacar")
datos$testigo <-  NULL
###############################################################################################################
#                                        Posiciones con fondos                                                #
###############################################################################################################
lista <- c("AXESEDM","NAVIGTR","+CIGUB","+CIGUMP","+CIGULP","+CIPLUS","+CIUSD","+CIEQUS","+CIBOLS")
funds <- ifelse(datos$emisora %in% lista, "Fondo", "No Fondo")
datos <- cbind(datos,funds)
fondos <- datos %>% filter(funds == "Fondo")
fondos <- data.frame(fecha =fondos$fecha,contrato =fondos$contrato,mon = fondos$mon,Codigo =fondos$Codigo)
sinfondos <- datos %>% filter(funds == "No Fondo")
#La siguiente linea se usa en caso de cobrar con mandato lo que pueda estar en fondos.
#sinfondos <- datos
sinfondos <- data.frame(fecha =sinfondos$fecha,contrato =sinfondos$contrato,cartera = sinfondos$carteramodelo ,
mon = sinfondos$mon,Codigo =sinfondos$Codigo,Emisora = sinfondos$emisora)
sinfondos$mon <- ifelse(sinfondos$mon > 0 , sinfondos$mon, 0)
###############################################################################################################
#                                                 Grupos                                                      #
###############################################################################################################
grupos <- data.frame(read_excel("comisiones.xlsx",sheet = 'Grupos'))
indicesg <- match(sinfondos$contrato,grupos$Titular)
grupo <- grupos$Grupo[indicesg]
sinfondos <- cbind(sinfondos,Grupo = grupo)
grupo1 <- sinfondos %>% group_by(Grupo,fecha) %>% summarise(Monto_Grupal = sum(mon))
sinfondos <- data.frame(merge(sinfondos, grupo1, by.x=c("fecha", "Grupo"), by.y=c("fecha", "Grupo")))
indiceserror <- which(is.na(sinfondos$Grupo) == TRUE)
sinfondos$Monto_Grupal[indiceserror] <- sinfondos$mon[indiceserror]
###############################################################################################################
#                                             Clientes especiales                                             #
###############################################################################################################
especiales <- data.frame(read_excel("comisiones.xlsx",sheet = 'Especiales'))
indicese <- match(sinfondos$contrato,especiales$Titular)
descuento <- 1 - especiales$Descuento[indicese]
descuento[is.na(descuento)] <- 1
sinfondos <- cbind(sinfondos,Descuento=descuento)
###############################################################################################################
#                                    Comisiones por instrumentos en fondos                                    #
###############################################################################################################
comision_fondo <- data.frame(read_excel("comisiones.xlsx",sheet = 'ComisionesFondos'))
comision_fondo$Fondo <- as.character(comision_fondo$Fondo)
indicesc <- match(fondos$Codigo,comision_fondo$Fondo)
comision_anualf <- comision_fondo$Comision[indicesc]
comision_diariaf <- comision_anualf / 365
comisionf <- fondos$mon * comision_diariaf
fondos <- cbind(fondos,Comision = comision_diariaf,MontoComision = comisionf)
comisionfondos <- dias_mes*sum(fondos$MontoComision)/as.numeric(length(unique(fondos$fecha)))
montofondos <- fondos %>% group_by(contrato) %>% summarise(MontoComision = sum(MontoComision))
montofondos$MontoComision <- dias_mes*montofondos$MontoComision/as.numeric(length(unique(fondos$fecha)))
###############################################################################################################
#                              Comisiones por instrumentos fuera de fondos                                    #
###############################################################################################################
comision_sinfondo <- data.frame(read_excel("comisiones.xlsx",sheet = 'ComisionesSinFondos'))
colnames(comision_sinfondo) <- gsub("\\.","-",colnames(comision_sinfondo))
colnames(comision_sinfondo) <- gsub("\\_"," ",colnames(comision_sinfondo))
###############################################################################################################
#                                           Saldo Diario                                                      #
###############################################################################################################
saldo_diario <- sinfondos %>% group_by(contrato,fecha) %>% summarise(Monto = sum(mon))
fechas <- unique(saldo_diario$fecha)
saldo_diario <- saldo_diario %>% complete(nesting(contrato),fecha = fechas,fill = list(Monto = 0))
diario <- data.frame(matrix(saldo_diario$Monto,nrow = length(fechas)),row.names = fechas)
colnames(diario) <- unique(saldo_diario$contrato)
###############################################################################################################
#                                           Cobros Especiales                                                 #
###############################################################################################################
cespeciales <- data.frame(read_excel("comisiones.xlsx",sheet = 'CobrosEspeciales'))
cespeciales$Contrato <- as.integer(cespeciales$Contrato)
bonificacion <- rep(0,length(sinfondos$contrato))
for (i in seq(1,length(cespeciales$Contrato), 1)){
indicesb <- match(cespeciales$Contrato[i],sinfondos$contrato)
bonificacion[indicesb] <- cespeciales$Bonificacion[i]
}
sinfondos <- cbind(sinfondos,Bonificacion = bonificacion)
###############################################################################################################
#                                               Cobro                                                         #
###############################################################################################################
saldopromedio <- colMeans(diario)
contratos <- colnames(diario)
cartera <- as.character(sinfondos$cartera[match(contratos,sinfondos$contrato)])
cobro <- data.frame(cbind(Contrato = contratos,SaldoProm = saldopromedio,Cartera = cartera))
cobro$SaldoProm <- as.numeric(as.character(cobro$SaldoProm))
Datoscobro <- sinfondos %>% group_by(contrato) %>% summarise(Promediogrupal = sum(Monto_Grupal)/as.numeric(length(unique(fondos$fecha))),
Descuento = mean(1-Descuento),
Bonificacion = sum(Bonificacion))
#Comision anual
indicescolumna <- match(cartera,colnames(comision_sinfondo))
indicesrenglon <- as.integer(sapply(Datoscobro$Promediogrupal,cajon))
comision_anuals <- c()
for (i in seq(1,length(indicescolumna),1)){
comision_anuals <- c(comision_anuals,comision_sinfondo[indicesrenglon[i],indicescolumna[i]])
}
Datoscobro <- cbind(Datoscobro,Anual = comision_anuals)
#CIBOLS y CIEQUS (sólo por la reclasificacion tardía).
fondos$Codigo <- as.character(fondos$Codigo)
prueba <- fondos %>%
filter(Codigo == "CIBOLS C-0" | Codigo == "CIEQUS C-0") %>%
group_by(contrato) %>% summarise(Monto = sum(mon)/as.numeric(length(unique(fondos$fecha))),
MontoComision = dias_mes*sum(MontoComision)/as.numeric(length(unique(fondos$fecha))))
serie <- sapply(prueba$Monto,cajon2)
codigo <- paste0("CIBOLS ",serie)
indicesci <- match(codigo,comision_fondo$Fondo)
comision_anualci <- comision_fondo$Comision[indicesci]
comision_anualci <- ifelse(is.na(comision_anualci) == TRUE, 0, comision_anualci)
comision_diariaci <- dias_mes*comision_anualci / 360
comisionci <- prueba$Monto * comision_diariaci
prueba <- data.frame(cbind(prueba,MontoComision2 = comisionci))
prueba$MontoComision2 <- as.numeric(as.character(prueba$MontoComision2))
i <- match(prueba$contrato,Datoscobro$contrato)
MontoComision3 <- prueba$MontoComision2 - prueba$MontoComision
MontoComision3 <- ifelse(MontoComision3 < 0 , 0, MontoComision3)
comisionfondos2 <- MontoComision3[match(contratos,prueba$contrato)]
comisionfondos2 <- ifelse(is.na(comisionfondos2) == TRUE, 0, comisionfondos2)
#AXESEDM (sólo por la reclasificacion tardía)
prueba2 <- fondos %>%
filter(Codigo == "AXESEDM F3") %>%
group_by(contrato) %>% summarise(Monto = sum(mon)/as.numeric(length(unique(fondos$fecha))),
MontoComision = dias_mes*sum(MontoComision)/as.numeric(length(unique(fondos$fecha))))
serie <- sapply(prueba2$Monto,cajon3)
codigo <- paste0("AXESEDM ",serie)
indicesci <- match(codigo,comision_fondo$Fondo)
comision_anualci <- comision_fondo$Comision[indicesci]
comision_anualci <- ifelse(is.na(comision_anualci) == TRUE, 0, comision_anualci)
comision_diariaci <- dias_mes*comision_anualci / 360
comisionci <- prueba2$Monto * comision_diariaci
prueba2 <- data.frame(cbind(prueba2,MontoComision2 = comisionci))
prueba2$MontoComision2 <- as.numeric(as.character(prueba2$MontoComision2))
i <- match(prueba2$contrato,Datoscobro$contrato)
MontoComision4 <- prueba2$MontoComision2 - prueba2$MontoComision
MontoComision4 <- ifelse(MontoComision4 < 0 , 0, MontoComision4)
comisionfondos3 <- MontoComision4[match(contratos,prueba2$contrato)]
comisionfondos3 <- ifelse(is.na(comisionfondos3) == TRUE, 0, comisionfondos3)
comision <- dias_mes*Datoscobro$Anual/360
comisiondesc <- comision * (1-Datoscobro$Descuento)
#############
monto <- (cobro$SaldoProm * dias_mes*Datoscobro$Anual/360)
monto <- ifelse(Datoscobro$Bonificacion <= 0, monto,Datoscobro$Bonificacion/1.16)
#############
montodesc <- (saldopromedio * comisiondesc)
montodesc <- ifelse(montodesc < 0, 0, montodesc) + comisionfondos2 + comisionfondos3
montodesc <- ifelse(Datoscobro$Bonificacion <= 0, montodesc,Datoscobro$Bonificacion/1.16)
montoiva <- montodesc * 1.16
montoneto <- ifelse(Datoscobro$Bonificacion <= 0, montodesc*1.16,Datoscobro$Bonificacion)
cobro <- cbind(cobro,Anual = Datoscobro$Anual,Comision = comision, Descuento = Datoscobro$Descuento,
ComisionConDescuento = comisiondesc, Monto = monto, MontoFondos = comisionfondos2+comisionfondos3,
MontoconDescuento = montodesc, MontoIVA = montoiva,
Bonificacion = Datoscobro$Bonificacion,MontoNetoIVA = montoneto, CobroFinal = montoneto)
cobro[-c(1,3)] <- cobro[-c(1,3)] %>% lapply(as.character) %>% lapply(as.numeric)
###############################################################################################################
#                                             Cargos                                                          #
###############################################################################################################
cargos  <- data.frame(cbind(Contrato = as.character(cobro$Contrato), CobroFinal = cobro$CobroFinal))
cargos$CobroFinal <- as.numeric(as.character(cobro$CobroFinal)) %>% round(4)
###############################################################################################################
#                                   Efectivo que no está en corto                                             #
###############################################################################################################
sinfondos$Codigo <- as.character(sinfondos$Codigo)
sinfondos$fecha <- as.character(sinfondos$fecha)
suficientes <- sinfondos %>% filter(fecha == as.character(diahoy)) %>% filter(Codigo == "EFECTIVO ")
suficientes <- data.frame(cbind(Contrato = suficientes$contrato,Efectivo =suficientes$mon))
efectivo <- data.frame(merge(cargos,suficientes,by.x=c('Contrato'),by.y=c('Contrato'),all.x = TRUE))
efectivo$Efectivo <- ifelse(is.na(efectivo$Efectivo)==TRUE,0,efectivo$Efectivo)
efectivo$Contrato <- as.character(efectivo$Contrato)
efectivo$Efectivo <- ifelse(efectivo$Efectivo>0,efectivo$Efectivo,0)
efectivosuficiente <- sum(ifelse(efectivo$Efectivo > efectivo$Cobro,efectivo$Cobro,efectivo$Efectivo))
###############################################################################################################
#                                              Resumen                                                        #
###############################################################################################################
nomresumen <- c('Dias en el mes','Suma sin Descuentos','Suma neta sin IVA','Suma neta con IVA',
'Suma neta con IVA quitando fondos insuficientes','Suma total en fondos')
resumen <- data.frame(matrix(c(dias_mes,sum(cobro$Monto)+sum(comisionfondos2)+sum(comisionfondos3),
sum(cobro$MontoconDescuento),sum(cobro$MontoNetoIVA), efectivosuficiente,
comisionfondos), nrow = 6),row.names = nomresumen)
###############################################################################################################
#                                                Excel                                                        #
###############################################################################################################
#Comisiones por mandato
dia <- Sys.Date()
archivom <- paste0('C:/Users/MATREJO/Documents/Comisiones/cargosCISM_',dia,'.xlsx')
write.xlsx2(cargos,archivom, sheetName = 'cargosCISM', col.names=TRUE, row.names = FALSE, append = FALSE)
write.xlsx2(resumen,archivom, sheet = 'ResumenCobro', col.names = FALSE, row.names = TRUE, append = TRUE)
write.xlsx2(cobro,archivom, sheet = 'completocobro', col.names = TRUE, row.names = FALSE, append = TRUE)
write.xlsx2(diario,archivom, sheet = 'saldoDiarioContratosMes', col.names = TRUE, row.names = TRUE,
append = TRUE)
write.xlsx2(grupos,archivom, sheet = 'Grupos', col.names = TRUE, row.names = FALSE, append = TRUE)
write.xlsx2(especiales,archivom, sheet = 'DescuentosEmpleados', col.names = TRUE, row.names = FALSE,
append = TRUE)
write.xlsx2(cespeciales,archivom, sheet = 'BonificacionesCargos', col.names = TRUE, row.names = FALSE,
append = TRUE)
#Clientes en corto
archivon <- 'C:/Users/MATREJO/Documents/Comisiones/ClientesenCorto.xlsx'
write.xlsx2(efectivo,archivon, sheetName = 'Clientes', col.names=TRUE, row.names = FALSE, append = FALSE)
